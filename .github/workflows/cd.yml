name: CD - Deploy Changed Services

on:
  push:
    branches:
      - main

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      user-service: ${{ steps.filter.outputs.user-service }}
      order-service: ${{ steps.filter.outputs.order-service }}
      book-service: ${{ steps.filter.outputs.book-service }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Detect Changed Folders
        uses: dorny/paths-filter@v3
        id: filter
        with:
          base: ${{ github.ref }}
          filters: |
            user-service:
              - "user-service/**"
            order-service:
              - "order-service/**"
            book-service:
              - "book-service/**"
            frontend:
              - "frontend/**"
      
      - name: Debug - Show detected services to deploy
        run: |
          echo "User service changed    : ${{ steps.filter.outputs.user-service }}"
          echo "Order service changed   : ${{ steps.filter.outputs.order-service }}"
          echo "Book service changed    : ${{ steps.filter.outputs.book-service }}"
          echo "Frontend changed        : ${{ steps.filter.outputs.frontend }}"

  deploy:
    needs: detect-changes
    runs-on: ubuntu-latest
    # Only run if at least one service changed
    if: |
      needs.detect-changes.outputs.user-service == 'true' ||
      needs.detect-changes.outputs.order-service == 'true' ||
      needs.detect-changes.outputs.book-service == 'true' ||
      needs.detect-changes.outputs.frontend == 'true'
    env:
      HELM_NAMESPACE: default
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'
      
      - name: Configure kubeconfig
        env:
          KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG_DATA }}
        run: |
          mkdir -p ~/.kube
          echo "$KUBE_CONFIG_DATA" | base64 --decode > ~/.kube/config
          chmod 600 ~/.kube/config
          kubectl config current-context
      
      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.12.0
      
      # ---------------------------
      # ðŸš€ HELM DEPLOYMENT STEPS
      # ---------------------------
      - name: Deploy user-service
        if: needs.detect-changes.outputs.user-service == 'true'
        run: |
          echo "Deploying user-service with 'latest' image"
          helm upgrade --install user-service ./user-service \
            --namespace $HELM_NAMESPACE \
            --set image.tag=latest
      
      - name: Deploy order-service
        if: needs.detect-changes.outputs.order-service == 'true'
        run: |
          echo "Deploying order-service with 'latest' image"
          helm upgrade --install order-service ./order-service \
            --namespace $HELM_NAMESPACE \
            --set image.tag=latest
      
      - name: Deploy book-service
        if: needs.detect-changes.outputs.book-service == 'true'
        run: |
          echo "Deploying book-service with 'latest' image"
          helm upgrade --install book-service ./book-service \
            --namespace $HELM_NAMESPACE \
            --set image.tag=latest
      
      - name: Deploy frontend
        if: needs.detect-changes.outputs.frontend == 'true'
        run: |
          echo "Deploying frontend-service with 'latest' image"
          helm upgrade --install frontend-service ./frontend \
            --namespace $HELM_NAMESPACE \
            --set image.tag=latest
      
      - name: Done
        run: echo "CD deployment completed successfully."
