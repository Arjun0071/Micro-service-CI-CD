name: CD - Deploy Changed Services (on CI success)

on:
  workflow_run:
    workflows: ["PR - Build Changed Microservices"]   # must match your CI workflow name exactly
    types:
      - completed

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    env:
      HELM_NAMESPACE: default   # override by setting this secret or change inline
    steps:
      - name: Checkout repo (full history)
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: '1.30.0'   # pick a version that matches your cluster

      - name: Configure kubeconfig from secret
        env:
          KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG_DATA }}
        run: |
          mkdir -p $HOME/.kube
          echo "$KUBE_CONFIG_DATA" | base64 --decode > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
          kubectl config current-context
      # Installs Helm
      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.12.0

      - name: Determine changed files (between HEAD and parent)
        id: changes
        run: |
          # Use the same head sha that CI used to tag images
          HEAD_SHA=${{ github.event.workflow_run.head_sha }}
          echo "CI pushed images for HEAD_SHA=$HEAD_SHA"

          # Ensure we have the commit history to compare parent
          git fetch --no-tags --prune --unshallow || true
          # If HEAD has a parent, compare; otherwise compare to empty tree
          if git rev-parse ${HEAD_SHA}^ >/dev/null 2>&1; then
            CHANGED=$(git diff --name-only ${HEAD_SHA}^ ${HEAD_SHA} || true)
          else
            CHANGED=$(git diff --name-only ${HEAD_SHA} ${HEAD_SHA} || true)
          fi

          echo "Changed files:"
          echo "$CHANGED"

          # expose flags for each service
          echo "::set-output name=user::$(echo \"$CHANGED\" | grep -E '^user-service/' >/dev/null && echo true || echo false)"
          echo "::set-output name=order::$(echo \"$CHANGED\" | grep -E '^order-service/' >/dev/null && echo true || echo false)"
          echo "::set-output name=book::$(echo \"$CHANGED\" | grep -E '^book-service/' >/dev/null && echo true || echo false)"
          echo "::set-output name=frontend::$(echo \"$CHANGED\" | grep -E '^frontend-service/|^frontend/' >/dev/null && echo true || echo false)"

      - name: Deploy user-service (helm)
        if: ${{ steps.changes.outputs.user == 'true' }}
        run: |
          echo "Deploying user-service with image tag=${{ github.event.workflow_run.head_sha }}"
          helm upgrade --install user-service ./user-service \
            --namespace ${HELM_NAMESPACE} \
            --set image.tag=${{ github.event.workflow_run.head_sha }}

      - name: Deploy order-service (helm)
        if: ${{ steps.changes.outputs.order == 'true' }}
        run: |
          echo "Deploying order-service with image tag=${{ github.event.workflow_run.head_sha }}"
          helm upgrade --install order-service ./order-service \
            --namespace ${HELM_NAMESPACE} \
            --set image.tag=${{ github.event.workflow_run.head_sha }}

      - name: Deploy book-service (helm)
        if: ${{ steps.changes.outputs.book == 'true' }}
        run: |
          echo "Deploying book-service with image tag=${{ github.event.workflow_run.head_sha }}"
          helm upgrade --install book-service ./book-service \
            --namespace ${HELM_NAMESPACE} \
            --set image.tag=${{ github.event.workflow_run.head_sha }}

      - name: Deploy frontend (helm)
        if: ${{ steps.changes.outputs.frontend == 'true' }}
        run: |
          echo "Deploying frontend-service with image tag=${{ github.event.workflow_run.head_sha }}"
          # your frontend chart dir is named frontend-service in your tree
          helm upgrade --install frontend-service ./frontend-service \
            --namespace ${HELM_NAMESPACE} \
            --set image.tag=${{ github.event.workflow_run.head_sha }}

      - name: Done
        run: echo "Deploy workflow finished"
